<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clase en Vivo - Zoom</title>
    
    <!-- Zoom Video SDK CSS -->
    <link rel="stylesheet" href="https://source.zoom.us/3.8.10/css/bootstrap.css">
    <link rel="stylesheet" href="https://source.zoom.us/3.8.10/css/react-select.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .header {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2563eb;
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .zoom-container {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .clase-info {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .clase-info h2 {
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .clase-info p {
            color: #6b7280;
            margin: 0.25rem 0;
        }

        .status-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .badge-live {
            background: #ef4444;
            color: white;
        }

        .join-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .input-group {
            flex: 1;
            min-width: 200px;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #374151;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
        }

        .btn {
            padding: 0.875rem 2rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1e40af;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #zmmtg-root {
            width: 100%;
            height: 700px;
            border-radius: 12px;
            overflow: hidden;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .success {
            background: #d1fae5;
            color: #065f46;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .info-card {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 8px;
        }

        .info-card h4 {
            color: #374151;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .info-card p {
            color: #1f2937;
            font-weight: 600;
        }

        .controls-bar {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }

        #join-controls.hidden {
            display: none;
        }

        #controls-bar.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">üéì Campus Virtual - Clase en Vivo</div>
        <button class="btn btn-secondary" onclick="volverAlCampus()">
            ‚Üê Volver al Campus
        </button>
    </div>

    <div class="container">
        <div class="zoom-container">
            <div id="loading" class="loading">
                <h3>‚è≥ Cargando informaci√≥n de la clase...</h3>
            </div>

            <div id="error-message" class="error" style="display: none;"></div>
            <div id="success-message" class="success" style="display: none;"></div>

            <div id="clase-info-container" style="display: none;">
                <div class="clase-info">
                    <h2 id="clase-titulo"></h2>
                    <p id="clase-descripcion"></p>
                    <div id="clase-status"></div>
                    
                    <div class="info-grid">
                        <div class="info-card">
                            <h4>üìö Curso</h4>
                            <p id="clase-curso"></p>
                        </div>
                        <div class="info-card">
                            <h4>üë®‚Äçüè´ Profesor</h4>
                            <p id="clase-profesor"></p>
                        </div>
                        <div class="info-card">
                            <h4>‚è±Ô∏è Duraci√≥n</h4>
                            <p id="clase-duracion"></p>
                        </div>
                        <div class="info-card">
                            <h4>üë• Participantes</h4>
                            <p id="clase-participantes"></p>
                        </div>
                    </div>
                </div>

                <div class="join-controls" id="join-controls">
                    <div class="input-group">
                        <label for="user-name">Tu Nombre Completo</label>
                        <input type="text" id="user-name" placeholder="Ej: Juan P√©rez" value="Estudiante">
                    </div>
                    <div class="input-group">
                        <label for="class-password">Contrase√±a de la Clase</label>
                        <input type="password" id="class-password" placeholder="Contrase√±a">
                    </div>
                    <div class="input-group" style="display: flex; align-items: flex-end;">
                        <button class="btn btn-primary" id="join-btn" onclick="joinMeeting()">
                            üé• Unirse a la Clase
                        </button>
                    </div>
                </div>

                <div class="controls-bar hidden" id="controls-bar">
                    <button class="btn btn-danger" onclick="leaveMeeting()">
                        üì¥ Salir de la Clase
                    </button>
                </div>
            </div>

            <div id="zmmtg-root"></div>
        </div>
    </div>

    <!-- Zoom Video SDK Scripts -->
    <script src="https://source.zoom.us/3.8.10/lib/vendor/react.min.js"></script>
    <script src="https://source.zoom.us/3.8.10/lib/vendor/react-dom.min.js"></script>
    <script src="https://source.zoom.us/3.8.10/lib/vendor/redux.min.js"></script>
    <script src="https://source.zoom.us/3.8.10/lib/vendor/redux-thunk.min.js"></script>
    <script src="https://source.zoom.us/3.8.10/lib/vendor/lodash.min.js"></script>
    <script src="https://source.zoom.us/zoom-meeting-embedded-3.8.10.min.js"></script>

    <script>
        const API_BASE = '/api';
        let currentClase = null;
        let client = null;

        const urlParams = new URLSearchParams(window.location.search);
        const claseId = urlParams.get('id');

        async function loadClaseInfo() {
            try {
                showLoading(true);
                const response = await fetch(`${API_BASE}/clases-zoom/${claseId}/`);
                
                if (!response.ok) {
                    throw new Error('Clase no encontrada');
                }
                
                currentClase = await response.json();
                displayClaseInfo(currentClase);
                
                showLoading(false);
                document.getElementById('clase-info-container').style.display = 'block';
                document.getElementById('class-password').value = currentClase.password || '';
                
            } catch (error) {
                showLoading(false);
                showError('Error al cargar la clase: ' + error.message);
            }
        }

        function displayClaseInfo(clase) {
            document.getElementById('clase-titulo').textContent = clase.titulo;
            document.getElementById('clase-descripcion').textContent = clase.descripcion;
            document.getElementById('clase-curso').textContent = clase.curso_nombre;
            document.getElementById('clase-profesor').textContent = clase.profesor;
            document.getElementById('clase-duracion').textContent = `${clase.duracion_minutos} minutos`;
            document.getElementById('clase-participantes').textContent = 
                `${clase.total_participantes} / ${clase.max_participantes}`;
            
            const statusBadge = document.getElementById('clase-status');
            if (clase.estado === 'en_vivo') {
                statusBadge.innerHTML = '<span class="status-badge badge-live">üî¥ EN VIVO</span>';
            } else if (clase.estado === 'programada') {
                statusBadge.innerHTML = '<span class="status-badge" style="background: #f59e0b; color: white;">üìÖ PROGRAMADA</span>';
            }
        }

        async function joinMeeting() {
            const userName = document.getElementById('user-name').value.trim();
            const password = document.getElementById('class-password').value.trim();
            
            if (!userName) {
                showError('Por favor ingresa tu nombre');
                return;
            }
            
            if (!password) {
                showError('Por favor ingresa la contrase√±a de la clase');
                return;
            }
            
            showSuccess('üîÑ Conectando a la clase...');
            document.getElementById('join-btn').disabled = true;
            
            try {
                console.log('Solicitando configuraci√≥n de Zoom...');
                
                const response = await fetch(`${API_BASE}/clases-zoom/${claseId}/join/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_name: userName,
                        is_host: false
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Error al conectar');
                }
                
                const config = await response.json();
                console.log('Configuraci√≥n recibida:', config);
                
                // Inicializar Zoom Client
                console.log('Inicializando Zoom SDK...');
                client = ZoomMtgEmbedded.createClient();
                
                const meetingSDKElement = document.getElementById('zmmtg-root');
                
                await client.init({
                    zoomAppRoot: meetingSDKElement,
                    language: 'es-ES',
                    patchJsMedia: true,
                    leaveOnPageUnload: true
                });
                
                console.log('Zoom SDK inicializado, uni√©ndose a la sesi√≥n...');
                
                await client.join({
                    signature: config.signature,
                    sdkKey: config.sdkKey,
                    meetingNumber: config.sessionName,
                    password: password,
                    userName: userName,
                    userEmail: '',
                    success: (success) => {
                        console.log('‚úÖ Conectado exitosamente', success);
                        showSuccess('‚úÖ ¬°Conectado a la clase!');
                        document.getElementById('join-controls').classList.add('hidden');
                        document.getElementById('controls-bar').classList.remove('hidden');
                    },
                    error: (error) => {
                        console.error('‚ùå Error al conectar', error);
                        showError('Error al conectar: ' + (error.reason || error.message || 'Desconocido'));
                        document.getElementById('join-btn').disabled = false;
                    }
                });
                
            } catch (error) {
                console.error('‚ùå Error general:', error);
                showError('Error: ' + error.message);
                document.getElementById('join-btn').disabled = false;
            }
        }

        function leaveMeeting() {
            if (client) {
                console.log('Saliendo de la clase...');
                client.leave();
                showSuccess('Has salido de la clase');
                document.getElementById('join-controls').classList.remove('hidden');
                document.getElementById('controls-bar').classList.add('hidden');
                document.getElementById('join-btn').disabled = false;
            }
        }

        function volverAlCampus() {
            if (client) {
                client.leave();
            }
            window.location.href = 'index.html';
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const errorEl = document.getElementById('error-message');
            errorEl.textContent = '‚ùå ' + message;
            errorEl.style.display = 'block';
            document.getElementById('success-message').style.display = 'none';
            setTimeout(() => errorEl.style.display = 'none', 8000);
        }

        function showSuccess(message) {
            const successEl = document.getElementById('success-message');
            successEl.textContent = message;
            successEl.style.display = 'block';
            document.getElementById('error-message').style.display = 'none';
            setTimeout(() => successEl.style.display = 'none', 5000);
        }

        // Cargar info al iniciar
        window.addEventListener('DOMContentLoaded', () => {
            if (!claseId) {
                showError('No se especific√≥ ID de clase en la URL');
                showLoading(false);
                return;
            }
            loadClaseInfo();
        });

        // Prevenir salir accidentalmente
        window.addEventListener('beforeunload', (e) => {
            if (client) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
